[pause_resume]

[display_status]

[virtual_sdcard]
path: ~/printer_1_data/gcodes
#Change this parameter according to which printer you are using in ChromaPad.
#Example: 3rd printer "path: ~/printer_3_data/gcodes"


[bed_screws]
#You can change these values â€‹â€‹â€‹â€‹according to the size of your printer and verify manually.
screw1: 30, 30
screw2: 150, 30
screw3: 30, 150
screw4: 150, 150


[gcode_macro UNLOAD_FILAMENT]
gcode:
      _CLIENT_LINEAR_MOVE E=-300 F=1200
      _CLIENT_LINEAR_MOVE E=-300 F=1200
      _CLIENT_LINEAR_MOVE E=-300 F=1200
      _CLIENT_LINEAR_MOVE E=-300 F=1200
      
[gcode_macro LOAD_FILAMENT]
gcode:
      #M83
      #G1 E100 F300
	  #M118
      _CLIENT_LINEAR_MOVE E=300 F=300
      _CLIENT_LINEAR_MOVE E=300 F=1200
      _CLIENT_LINEAR_MOVE E=300 F=1200
    
[gcode_macro PARK_FILAMENT]
gcode:
      M83
      G1 E-100 F300

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
variable_extrude: 0.5
gcode:
  SAVE_VARIABLE VARIABLE=started_printing VALUE=False  ; turns off filament runout sensor from detecting a filament runout
  
  ##### set park position for x and y #####
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  {% set z_park_delta = 2.0 %}
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - z_park_delta) %}
    {% set z_safe = z_park_delta %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}

  ##### nozzle clean logic #####
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% if printer.extruder.can_extrude|lower == 'true' %}
      M83
      G1 E-{extrude} F300
      {% if printer.gcode_move.absolute_extrude|lower == 'true' %} M82 {% endif %}
      NOZZLE_CLEAN
      RESPOND MSG="ðŸ§¼ Nozzle cleaned before parking"
    {% else %}
      {action_respond_info("âš ï¸ Skipped cleaning: extruder not hot")}
    {% endif %}

    ##### park sequence #####
    G91             ; Sets relative position
    G1 Z{z_safe} F900
    G90             ; Sets Absolute position
    G1 X0 Y406 F1800 ; Park ChromaHead
    ;G1 X{x_park} Y{y_park} F6000
    {% if printer.gcode_move.absolute_coordinates|lower == 'false' %} G91 {% endif %}
  {% else %}
    {action_respond_info("âš ï¸ Skipped parking: printer not homed")}
  {% endif %}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
  ## Move head and retract only if not already in the pause state and park set to true

  {% if printer.pause_resume.is_paused|lower == 'false' and park|lower == 'true'%}
    _TOOLHEAD_PARK_PAUSE_CANCEL
    RESPOND MSG="ðŸ§¼ Toolhead parked and cleaned after cancel."
  {% endif %}

  SET_FILAMENT          ; Cut and retract filamnt
  RESPOND MSG="âœ‚ï¸ Filament cut and retracted."
  #FILAMENT_CUT
  #G92 E0
  #G1 E-100 F300
  CANCEL_PRINT_BASE
  TURN_OFF_HEATERS
  M106 S0                                             ; Set Fan Speed to -0-
  
  ;  THIS SECTION IS THE RUNOUT SENSOR VARIABLES THAT GET RESET STARTING EVERY PRINT
    SAVE_VARIABLE VARIABLE=started_printing VALUE=False  ; turns on filament runout sensor for detecting a filament runout
    SAVE_VARIABLE VARIABLE=printer_paused VALUE=False   ; let's the runout sensor know that it cannot auto-load filament
    SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
    SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
    SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=0
    SAVE_VARIABLE VARIABLE=start_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;Used in filament loading macros
    SAVE_VARIABLE VARIABLE=filament_used VALUE=0
    SAVE_VARIABLE VARIABLE=filament_remaining VALUE=0
  ;       END OF RUNOUT SENSOR VARIABLES

  ;   resets the skew fix
    SET_SKEW CLEAR=1
    
  SAVE_VARIABLE VARIABLE=extruder_temperature VALUE=0  ;  records the extruder temperature
  RESPOND MSG="ðŸ›‘ Print state cleared. Heaters off, Cooling fan off, Variables reset."

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  _TOOLHEAD_PARK_PAUSE_CANCEL

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  SAVE_VARIABLE VARIABLE=started_printing VALUE=True  ; turns on filament runout sensor for detecting a filament runout
  {% set target_temp = printer.save_variables.variables.extruder_temperature %}
  
  RESPOND MSG="âœ‹ Wait while the extruder is brought up to working temperature ('{target_temp}') âœ‹"      ; respond message
  M109 S{target_temp}         ; Wait for nozzle to heat-up to final temp  (added by MS CoPilot)
  RESPOND MSG="âœ¨ Printer is now resuming print âœ¨"
       
  ##### read extrude from  _TOOLHEAD_PARK_PAUSE_CANCEL  macro #####
  {% set extrude = printer['gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL'].extrude %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G1 E{extrude} F300
    ;G1 E{extrude} F2100
    {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  
  RESUME_BASE {get_params}

[gcode_macro END_PRINT]
gcode:
    {% set x_stop = params.X|default(printer.toolhead.axis_maximum.x-5)|int %}
    {% set y_stop = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %}
    {% set z_stop = printer.toolhead.axis_maximum.z|int %}
    {% set z_pos = printer.toolhead.position.z|int %}

    {% if z_pos < (z_stop-6) %}
      G91
      G1 E-2 F300
      G1 Z5
    {% else %}
      G91
      G1 E-2 F300
      G1 Z1
    {% endif %}

    G90                                                    ; Set Absolute Position
    G1 X0 Y406 F3000                                       ; Move to waiting area
    SET_FILAMENT                                           ; Cut and retract filament
    #G92 E0
    #G1 E-100 F300
    NOZZLE_CLEAN                                           ; Clean the Nozzle
    G90                                                    ; Set Absolute Position
    G1 X0 Y406 F1800                                       ; Move to waiting area
    ;G1 X{x_stop} Y{y_stop} F1800
    M106 S0                                                ; Set Fan Speed to -0-
    M104 S0                                                ; Set Nozzle Temperature to -0-
    M140 S0                                                ; Set Bed Temperature to -0-

    ;   resets the skew fix
    SET_SKEW CLEAR=1
    
    ;  THIS SECTION IS THE RUNOUT SENSOR VARIABLES THAT GET RESET STARTING EVERY PRINT
    SAVE_VARIABLE VARIABLE=started_printing VALUE=False  ; turns on filament runout sensor for detecting a filament runout
    SAVE_VARIABLE VARIABLE=printer_paused VALUE=False   ; let's the runout sensor know that it cannot auto-load filament
    SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
    SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
    SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=0
    SAVE_VARIABLE VARIABLE=start_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;Used in filament loading macros
    SAVE_VARIABLE VARIABLE=filament_used VALUE=0
    SAVE_VARIABLE VARIABLE=filament_remaining VALUE=0
    ;       END OF RUNOUT SENSOR VARIABLES
    
    SAVE_VARIABLE VARIABLE=extruder_temperature VALUE=0    ;  records the extruder temperature

[gcode_macro START_PRINT]
variable_started_printing: False
variable_extruder_temperature: 0
gcode:
    ;  THIS SECTION IS THE RUNOUT SENSOR VARIABLES THAT GET RESET STARTING EVERY PRINT
    SAVE_VARIABLE VARIABLE=started_printing VALUE=True  ; turns on filament runout sensor for detecting a filament runout
    SAVE_VARIABLE VARIABLE=printer_paused VALUE=False   ; let's the runout sensor know that it cannot auto-load filament
    SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
    SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
    SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=0
    SAVE_VARIABLE VARIABLE=start_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE=0
    SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;Used in filament loading macros
    SAVE_VARIABLE VARIABLE=filament_used VALUE=0
    SAVE_VARIABLE VARIABLE=filament_remaining VALUE=0
    ;       END OF RUNOUT SENSOR VARIABLES

    ;  THIS RESETS THE CLEANING NOZZLE COUNT VARIABLE
    SAVE_VARIABLE VARIABLE=filament_change_count VALUE=0  ; Reset variable for nozzle_clean
    ;       END OF CLEANING NOZZLE COUNT VARIABLE
    
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    {% set CURR_BED_TYPE = params.CURR_BED_TYPE|default("unknown")|string %}
    {% set MATERIAL = params.MATERIAL|default("unknown")|string %}
    {% set axismax = printer.toolhead.axis_maximum %}
    {% set axismin_x = printer.toolhead.axis_minimum.x %}
    {% set axismin_y = printer.toolhead.axis_minimum.y %}
    SAVE_VARIABLE VARIABLE=extruder_temperature VALUE={EXTRUDER_TEMP}  ;  records the extruder temperature

;   loads the skew profile for PETG
    SKEW_PROFILE LOAD=PETG
    
;   this sets the Z-Offset depending on what type of plate is used    
    {% if CURR_BED_TYPE == "Textured PEI Plate" and MATERIAL == "PETG"%}
        SET_GCODE_OFFSET Z_ADJUST=0.00 MOVE=1
    {% endif %}
    
    {% if CURR_BED_TYPE == "Smooth High Temp Plate" and MATERIAL == "PETG"%}
        SET_GCODE_OFFSET Z_ADJUST=0.00 MOVE=1
    {% endif %}

    G28                           ; Home all axis (added by MS CoPilot)
    T{EXTRUDER}                   ; Choose Extruder (added by MS CoPilot)
    M140 S{BED_TEMP}              ; Non-blocking bed heat (added by MS CoPilot)
    M104 S{EXTRUDER_TEMP - 50}    ; Preheat nozzle slightly (added by MS CoPilot)
    G90                           ; Set absolute position of ChromaHead (added by MS CoPilot)
    G1 Z10 F450                   ; Lift head up 10mm - to make sure bed level sensor isn't activated
    M190 S{BED_TEMP}              ; Wait for bed to heat up (added by MS CoPilot)
    BED_MESH_CALIBRATE ADAPTIVE=1 ; Detect the bed mesh (added by MS CoPilot)
    G1 X0 Y400 F6000              ; Move to cleaning area (added by MS CoPilot)
    M109 S{EXTRUDER_TEMP}         ; Wait for nozzle  (added by MS CoPilot)
    RESPOND MSG="ðŸ³ï¸â€ðŸŒˆ Priming Filament Nozzle ðŸ³ï¸â€ðŸŒˆ"
    G92 E0                        ; Reset extruder position to zero (added by MS CoPilot)
    G1 E50 F500
    G92 E0                        ; Reset extruder position to zero (added by MS CoPilot)
    G1 E50 F500
    G92 E0                        ; Reset extruder position to zero (added by MS CoPilot)
    G1 E20 F300
    G92 E0                        ; Reset extruder position to zero (added by MS CoPilot)
    ;G1 E85 F300                   ; Prime Nozzle after heating  (added by MS CoPilot)
    G4 P5000                       ; Pause for 5000 miliseconds/5 seconds
    NOZZLE_CLEAN                  ; Clean nozzle after priming

    # Heat bed for probing
    #M190 S{BED_TEMP}
    # Use absolute coordinates
    #G90
    # Home the printer
    #G28  
    #G1 Z10 F450
    #G92 E0                    #PUT IN BY ME - RESETS EXTRUDER POSITION
    #G1 E85 F300              #PUT IN BY ME - GET FILAMENT READY TO PRINT
    #M109 S{EXTRUDER_TEMP}
    #T{EXTRUDER}
    
    {% if axismax.x > 200 %}
      G92 E0 
      G1 X25 Y129 Z0.4 F1800           #G1 X50 Y152 Z0.4 F900 
      G92 E0
      G1 Y54 E20 F900            #G1 Y77 E20 F900 
      G92 E0
      G1 Y-23 E20 F900           #G1 Y2 E20 F900
      G92 E0
      G1 X125 E30 F900           #G1 X125 E30 F900 
      G92 E0
      G1 X225 E30 F900           #G1 X225 E30 F900 
      G92 E0
      G1 Y-21 F900 
      G92 E0
      G1 X125 E30 F900           #G1 X100 E30 F900
      G92 E0
      G1 X27 E30 F900            #G1 X52 E30 F900 
      G92 E0
      G1 Y54 E20 F900
      G92 E0
      G1 Y129 E20 F900
      G92 E0 ;Reset Extruder
    {% else %}
    {% if axismax.y > 153 %}
      G92 E0 ;Reset Extruder
      G1 X{axismin_x + 2} Y152 Z0.4 F900 ;Move to start position
      G92 E0
      G1 Y77 E20 F900 ;Draw the first line
      G92 E0
      G1 Y2 E20 F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x / 2} E30 F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x - 2} E30 F900 ;Draw the first line
      G92 E0
      G1 Y{axismin_y + 4} F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x / 2} E30 F900 ;Draw the first line
      G92 E0
      G1 X{axismin_x + 4} E30 F900 ;Draw the first line
      G92 E0
      G1 Y77 E20 F900 ;Draw the first line
      G92 E0
      G1 Y152 E20 F900
      G92 E0
    {% else %}
      G92 E0 ;Reset Extruder
      G1 X{axismin_x + 2} Y{axismax.Y - 2} Z0.4 F900 ;Move to start position
      G92 E0
      G1 Y{axismax.Y / 2} E20 F900 ;Draw the first line
      G92 E0
      G1 Y2 E20 F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x / 2} E30 F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x - 2} E30 F900 ;Draw the first line
      G92 E0
      G1 Y{axismin_y + 4} F900 ;Draw the first line
      G92 E0
      G1 X{axismax.x / 2} E30 F900 ;Draw the first line
      G92 E0
      G1 X{axismin_x + 4} E30 F900 ;Draw the first line
      G92 E0
      G1 Y{axismax.Y / 2} E20 F900 ;Draw the first line
      G92 E0
      G1 Y{axismax.Y - 2} E20 F900
      G92 E0
    {% endif %}
    {% endif %}


    G92 E0 ;Reset Extruder

[exclude_object] 

#The following code should be added to the start gcode section of the slicer application used.
#start_print  EXTRUDER=[initial_extruder] EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]


[respond]
default_type: echo
default_prefix:

[gcode_macro SET_FILAMENT_POSITION]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin Set Filament Position"
    RESPOND TYPE=command MSG="action:prompt_text Make sure the extruder is sufficiently heated and the correct extruder is selected."
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button T0|T0|primary"
    RESPOND TYPE=command MSG="action:prompt_button T1|T1|primary"
    RESPOND TYPE=command MSG="action:prompt_button T2|T2|primary"
    RESPOND TYPE=command MSG="action:prompt_button T3|T3|primary"
    RESPOND TYPE=command MSG="action:prompt_button T4|T4|primary"
    RESPOND TYPE=command MSG="action:prompt_button T5|T5|primary"
    RESPOND TYPE=command MSG="action:prompt_button T6|T6|primary"
    RESPOND TYPE=command MSG="action:prompt_button T7|T7|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button EXTRUDE|EXTRUDE_H|warning"
    RESPOND TYPE=command MSG="action:prompt_button SET|SET_FILAMENT|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"
 
[gcode_macro EXTRUDE_H]
gcode:
    {% set temperature = printer.extruder.temperature|int %}
    {% if temperature > 199 %}
    G92 E0
#    G1 E20 F500
    G1 E30 F300
    G92 E0
#    G1 E20 F500
    G1 E30 F300
    G92 E0
#    G1 E20 F500
    G1 E30 F300
    G92 E0
#    G1 E20 F500
    G1 E30 F300
    G92 E0
#    G1 E20 F500
    G1 E20 F300
    G92 E0
    {% endif %}

[gcode_macro SET_FILAMENT]
gcode:
    FILAMENT_CUT
    FILAMENT_CUT
    G92 E0
#    G1 E-20 F500
    G1 E-30 F300
    G92 E0
#    G1 E-20 F500
    G1 E-30 F300
    G92 E0
#    G1 E-20 F500
    G1 E-30 F300
    G92 E0
#    G1 E-25 F500
    G1 E-30 F300
    G92 E0


[gcode_macro FILAMENT_CHANGE]
gcode:
    {% set LAYER_NUM = params.LAYER_NUM|int %}
    {% set POS_X = printer.toolhead.position.x %}
    {% set POS_Y = printer.toolhead.position.y %}
    {% set POS_Z = printer.toolhead.position.z %}
    {% set NEXT_EXTRUDER = params.NEXT_EXTRUDER|int %}
    {% set nozzle_clean_layer = printer.save_variables.variables.nozzle_clean_layer %}
    {% set filament_change_count = printer.save_variables.variables.filament_change_count | int %}

    {% if LAYER_NUM == -1 %}
    ; No filament change requiredâ€”skipping macro
    {% endif %}

    {% if LAYER_NUM != -1 %}
    {% set filament_change_count = filament_change_count + 1 %}
    ; Move to safe space to change filament    
      RESPOND MSG="ðŸŽ­ --- Starting Filament Change Routine --- ðŸŽ­"
      ;G91                           ; Set Relative Position
      ;G1 Z{POS_Z+20} F1800          ; Lift Nozzle Head off the bed
      
      ;G90                           ; Set Absolute Position
      ;G1 X380 Y390 F1500
      ;G1 Z0.20 F300
      ;G1 X121 Y405 F1500              ; Move to drip tray next to nozzle brush
      ;G1 Z3.750 F300
      FILAMENT_CUT                  ; Cut Filament
      FILAMENT_CUT
      ;G4 P300                       ; Pause to stabilize printer

    ; Retract Filament
      G91                 ; Set Relative Position
    G1 X10 E-40 F300
      ;G1 X-45 E-25 F300        ; Start pulling 25mm of filament
      G92 E0              ; Reset extruder to Zero
    G1 X-20 E-40 F500
      ;G1 X35 E-30 F500        ; pull 30mm of filament
      G92 E0              ; Reset extruder to Zero
    G1 X10 E-40 F500
      ;G1 X-35 E-30 F500          ; pull final 30mm of filament
      
    #{% if filament_change_count == 5 %}
     #  NOZZLE_CLEAN
      # G90                          ; Set Absolute Position
       #G1 X{POS_X} Y{POS_Y} F1800   ; Move Nozzle back to prime tower
      # G1 Z{nozzle_clean_layer} F1800        ; Reset back to original layer
      # {% set filament_change_count = 0 %}
    #{% endif %}
    #SAVE_VARIABLE VARIABLE=filament_change_count VALUE={filament_change_count}  
    ; Extrude Filament
      T{NEXT_EXTRUDER}
      
      G91                 ; Set Relative Position
      G92 E0              ; Reset extruder to Zero
#    G1 X-10 E25 F500
      G1 X-10 E30 F500
      ;G1 X35 E25 F500         ; push 25mm of filament
      G92 E0              ; Reset extruder to Zero
#    G1 X10 E20 F300
      G1 X10 E30 F300
      ;G1 X-35 E20 F300         ; push 20mm of filament
      G92 E0              ; Reset extruder to Zero
#    G1 X-10 E20 F300
      G1 X-10 E30 F300
      ;G1 X35 E20 F300         ; push 20mm of filament
      G92 E0              ; Reset extruder to Zero
#    G1 X10 E25 F300
      G1 X10 E30 F300
      ;G1 X-35 E5 F300         ; push final 20mm of filament
      
    
      ;G91                           ; Set Relative Position
      ;G1 Z{POS_Z+20} F1800          ; Lift Nozzle Head off the bed
      ;G90
      ;G1 X121 Y405 F1500
      ;G1 Z3.750 F300
      ;G91
      ;G1 X-50 F1500
      ;G1 X25 Y-2 F1500
      ;G1 X25 Y2 F1500
      ;G1 X-50 F1500

      ;G91
      ;G1 Z{POS_Z+20} F1800
      ;NOZZLE_CLEAN        ; Clean nozzle after filament swap and purge
      RESPOND MSG="ðŸŽ­ --- Filament Change Complete --- ðŸŽ­"
      ;G90                          ; Set Absolute Position
      ;G1 X{POS_X} Y{POS_Y} F1800   ; Move Nozzle back to prime tower
      ;G1 Z{nozzle_clean_layer} F1800        ; Reset back to original layer
      ;G92 E0
      ;G1 E23 F300
      G90
    {% endif %}

# FILAMENT_CHANGE LAYER_NUM=[layer_num] NEXT_EXTRUDER=[next_extruder]

[gcode_macro G3]
gcode:
    G4 P0

[gcode_macro G17]
gcode:
    G4 P0
